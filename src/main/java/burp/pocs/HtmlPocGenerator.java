
package burp.pocs;

import java.util.List;
import burp.IParameter;
import burp.IRequestInfo;
import burp.util.Request;
import burp.util.Util;

/**
 * HTML CSRF POCs
 * 
 * @author Joaquin R. Martinez <joaquin.ramirez.mtz.lab@gmail.com>
 */
public class HtmlPocGenerator implements PocGenerator {

	@Override
	public byte[] generate(Request request) {
		String enctype = "";
		if (request.getContentType() == IRequestInfo.CONTENT_TYPE_MULTIPART) {
			enctype = "enctype=\"multipart/form-data\"";
		}
		String lineSep = System.lineSeparator();
		String pocString = String.format("\t<form method=\"%s\" action=\"%s\" %s>%s", request.getMethod(),
				request.getUrl().toString(), enctype, lineSep);
		pocString += createInputs(request.getParameters(), lineSep);
		pocString += "\t</form>" + lineSep;
		return createHTMLPage(pocString, lineSep).getBytes();
	}

	private String createInputs(List<IParameter> parameters, String lineSep) {
		List<String> inputs = parameters.stream().map(e -> createInput(e)).toList();
		String pocString = String.join(lineSep, inputs) + lineSep;
		pocString += "\t\t<input type=\"submit\" value=\"Send\">" + lineSep;
		return pocString;
	}

	private String createInput(IParameter parameter) {
		String name = Util.encodeHTML(parameter.getName());
		String value = Util.encodeHTML(parameter.getValue());
		return String.format("\t\t<input type=\"text\" name=\"%s\" value=\"%s\">", name, value);
	}

	private String createHTMLPage(String body, String lineSeparator) {
		String html = "<!DOCTYPE html>" + lineSeparator;
		html += "<html>" + lineSeparator;
		html += "\t<!-- CSRF PoC - generated by Burp Suite plugin -->" + lineSeparator;
		html += "\t<body>" + lineSeparator;
		html += body;
		html += "\t</body>" + lineSeparator;
		html += "</html>";
		return html;
	}
	
}
